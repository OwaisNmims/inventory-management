<!DOCTYPE html>
<html lang="en">
<%- include ('../partials/head') %>

<!--  BEGIN NAVBAR  -->
<%- include ('../partials/header') %>
<!--  END NAVBAR  -->

<!--  BEGIN MAIN CONTAINER  -->
<div class="main-container" id="container">
  <div class="overlay"></div>
  <div class="search-overlay"></div>

  <!--  BEGIN SIDEBAR  -->
  <%- include ('../partials/sidebar') %>
  <!--  END SIDEBAR  -->

  <!--  BEGIN CONTENT AREA  -->
  <div id="content" class="main-content">
    <div class="layout-px-spacing">
      <div class="middle-content container-xxl p-0">
        <!--  BEGIN BREADCRUMBS  -->
        <div class="secondary-nav">
          <div class="breadcrumbs-container" data-page-heading="Analytics">
            <header class="header navbar navbar-expand-sm">
              <a href="javascript:void(0);" class="btn-toggle sidebarCollapse" data-placement="bottom">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
              </a>
              <div class="d-flex breadcrumb-content">
                <div class="page-header">
                  <div class="page-title"></div>

                  <nav class="breadcrumb-style-one" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li class="breadcrumb-item active">
                        <a href="./masters">Master</a>
                      </li>
                      <li class="breadcrumb-item active" aria-current="page">
                        Company
                      </li>
                    </ol>
                  </nav>
                </div>
              </div>
            </header>
          </div>
        </div>
        <!--  END BREADCRUMBS  -->

        <div class="main-content">
          <div class="table-template">
            <div class="table-header">
              <div class="table-title">
                <h3>Company</h3>
              </div>
              <div class="table-actions">
                <button style="background: none; border: none" class="create-company-modal">
                  <i class="fa-regular fa-square-plus"></i>
                </button>
              </div>
            </div>

            <div class="table-content">
              <div class="table-filter-container"></div>
              <div class="table-content">
                <div class="table-responsive">
                  <table class="table table-bordered" id="table-content">
                    <thead>
                      <tr>
                        <th scope="col">Sr No.</th>
                        <th scope="col">Company Name</th>
                        <th scope="col">Company Code</th>
                        <th scope="col">Company Type</th>
                        <th scope="col">Email</th>
                        <th scope="col">Phone</th>
                        <th scope="col">City</th>
                        <th scope="col">Registration No.</th>
                        <th class="text-center" scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% let i=1; for(let data of companies) { %>

                      <tr data-id="<%= data.id %>">
                        <td>
                          <%= i %>
                        </td>

                        <td class="company-name">
                          <%= data.name %>
                        </td>
                        <td class="company-code">
                          <%= data.company_code %>
                        </td>
                        <td>
                          <%= data.company_type_name || '-' %>
                        </td>
                        <td>
                          <%= data.email || '-' %>
                        </td>
                        <td>
                          <%= data.phone || '-' %>
                        </td>
                        <td>
                          <%= data.city_name || '-' %>
                        </td>
                        <td>
                          <%= data.registration_number || '-' %>
                        </td>
                        <td class="text-center">
                          <div class="action-btns">
                            <a href="javascript:void(0);" class="action-btn btn-edit bs-tooltip me-2" data-id="<%= data.id %>" data-toggle="tooltip" data-placement="top" title="Edit">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                              </svg>
                            </a>
                            <a href="javascript:void(0);" class="action-btn btn-delete bs-tooltip" data-id="<%= data.id %>" data-toggle="tooltip" data-placement="top" title="Delete">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                              </svg>
                            </a>
                          </div>
                        </td>
                      </tr>

                      <% i++ %>
                      <% } %>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--  END CONTENT AREA  -->
</div>
<!-- END MAIN CONTAINER -->

<!--ADD Modal -->
<div class="modal fade" id="add-company-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="add-company-modal" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content modal-inputform">
      <div class="modal-header modal-inputform-header">
        <h5 class="modal-title text-dark" id="">ADD COMPANY</h5>
        <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="row info-container">
          <div class="col-md-3 select-fields">
            <div class="mb-3">
              <label class="form-label" for="add-company-name">Company Name</label>
              <input type="text" class="form-control" id="add-company-name" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="add-company-code">Company Code</label>
              <input type="text" class="form-control" id="add-company-code" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="add-company-email">Email</label>
              <input type="email" class="form-control" id="add-company-email" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="add-company-phone">Phone</label>
              <input type="text" class="form-control" id="add-company-phone" />
            </div>
                         <div class="mb-3">
               <label class="form-label" for="add-registration-number">Registration Number</label>
               <input type="text" class="form-control" id="add-registration-number" />
             </div>
             <div class="mb-3">
               <label class="form-label" for="add-company-type">Company Type</label>
               <select class="form-control" id="add-company-type">
                 <option value="" disabled selected>Select Company Type...</option>
                 <% companyTypes.forEach((companyType) => { %>
                   <option value="<%= companyType.id %>"><%= companyType.name %></option>
                 <% }) %>
               </select>
             </div>

             <div class="mb-3 d-grid gap-2">
               <button class="btn text-light add-company btn-info">ADD</button>
             </div>
          </div>
          <div class="col-md-9 selected-fields">
            <div class="table-responsive">
              <table class="table table-bordered" id="add-more-company-table">
                <thead>
                  <th>Sr No.</th>
                  <th>Company Name</th>
                  <th>Company Code</th>
                  <th>Company Type</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Registration No.</th>
                  <th>Action</th>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn create-company btn-primary">
          CREATE
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->

<div class="modal fade" id="edit-company-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="edit-company-modal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content modal-inputform">
      <div class="modal-header modal-inputform-header">
        <h5 class="modal-title text-dark" id="">EDIT COMPANY</h5>
        <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="row select-fields">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label" for="edit-company-name">Company Name</label>
              <input type="text" class="form-control" id="edit-company-name" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-company-code">Company Code</label>
              <input type="text" class="form-control" id="edit-company-code" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-company-email">Email</label>
              <input type="email" class="form-control" id="edit-company-email" />
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label" for="edit-company-phone">Phone</label>
              <input type="text" class="form-control" id="edit-company-phone" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-registration-number">Registration Number</label>
              <input type="text" class="form-control" id="edit-registration-number" />
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-company-type">Company Type</label>
              <select class="form-control" id="edit-company-type">
                <option value="" disabled>Select Company Type...</option>
                <% companyTypes.forEach((companyType) => { %>
                  <option value="<%= companyType.id %>"><%= companyType.name %></option>
                <% }) %>
              </select>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn save-company btn-primary">SAVE</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<%- include ('../partials/footer') %>

<!-- CUSTOM JS SCRIPT -->
<script>
  $(document).ready(function() {
    $(".create-company-modal").on("click", function() {
      $("#add-company-modal").modal("show");
    });

    function serializeTable(tableId) {
      let i = 1;
      $(`#${tableId} tbody tr`).each((index, element) => {
        $(element).find("td:eq(0)").text(i);
        i++;
      });
    }

    $(document).on("click", ".add-company", function() {
      let companyName = $("#add-company-name").val();
      let companyCode = $("#add-company-code").val();
      let email = $("#add-company-email").val();
      let phone = $("#add-company-phone").val();
      let registrationNumber = $("#add-registration-number").val();
      let companyTypeLid = $("#add-company-type").val();
      let companyTypeName = $("#add-company-type option:selected").text();
      
      companyName = companyName.trim();
      companyCode = companyCode.trim().toUpperCase();
      
      let duplicate = false;
      if ($(document).find(".add-company-row").length > 0) {
        $(document).find(".add-company-row").each((index, element) => {
          if ($(element).find('.company-name').text() == companyName || $(element).find('.company-code').text() == companyCode) {
            createAlert({
              title: 'ERROR',
              msg: 'You cannot add duplicate Company Name/Code',
              type: 'negative'
            })
            duplicate = true;
          }
        });
      }
      if (duplicate) {
        return;
      }

      if (!companyName || !companyCode) {
        createAlert({
          title: 'ERROR',
          msg: 'Company Name and Code are required',
          type: 'negative'
        });
        return;
      }

      let count = $("#add-more-company-table tbody tr").length == undefined ? 0 : $("#add-more-company-table tbody tr").length;
      let tableRow = `<tr class="add-company-row" data-company-type-lid="${companyTypeLid || ''}">
            <td>${++count}</td>
            <td class="company-name">${companyName}</td>
            <td class="company-code">${companyCode}</td>
            <td class="company-type-name">${companyTypeName || '-'}</td>
            <td class="company-email">${email || '-'}</td>
            <td class="company-phone">${phone || '-'}</td>
            <td class="registration-number">${registrationNumber || '-'}</td>
            <td><button class='delete-row'>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                </button></td>
            </tr>`;

      $("#add-more-company-table tbody").append(tableRow);
      $("#add-company-name").val('');
      $("#add-company-code").val('');
      $("#add-company-email").val('');
      $("#add-company-phone").val('');
      $("#add-registration-number").val('');
      $("#add-company-type").val('').trigger('change');
    });

    // add-company modal - for deleting added companies in table
    $(document).on("click", ".delete-row", function() {
      let tableId = $(this).closest("table").attr("id");
      $(this).closest("tr").remove();
      if ($(`#${tableId} tbody tr`).length > 0) {
        serializeTable(tableId);
      }
    });

    // CREATE COMPANY START
    $(document).on("click", ".create-company", function() {
      let companies = [];
      if ($(document).find(".add-company-row").length > 0) {
        $(document).find(".add-company-row").each((index, element) => {
          let obj = {
            name: $(element).find('.company-name').text().trim(),
            companyCode: $(element).find('.company-code').text().trim(),
            email: $(element).find('.company-email').text().trim() === '-' ? '' : $(element).find('.company-email').text().trim(),
            phone: $(element).find('.company-phone').text().trim() === '-' ? '' : $(element).find('.company-phone').text().trim(),
            registrationNumber: $(element).find('.registration-number').text().trim() === '-' ? '' : $(element).find('.registration-number').text().trim(),
            companyTypeLid: $(element).attr('data-company-type-lid') || null
          }
          companies.push(obj);
        });
      }

      if (companies.length === 0) {
        createAlert({
          title: 'ERROR',
          msg: 'Please add at least one company',
          type: 'negative'
        });
        return;
      }

      $.ajax({
        method: "POST",
        url: "/admin/company/insert",
        headers: {
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          companyList: companies
        }),
        success: function(response) {
          if (response.status === 200) {
            createAlert({
              title: "SUCCESS",
              msg: response.data.message,
              type: "positive",
            });
            setTimeout(() => {
              location.reload(true);
            }, 2000);
          } else {
            createAlert({
              title: "ERROR",
              msg: response.data.message,
              type: "negative",
            });
          }
          $("#add-company-modal").modal("hide");
        },
        error: function(error) {
          createAlert({
            title: "ERROR",
            msg: "Something went wrong!",
            type: "negative",
          });
          $("#add-company-modal").modal("hide");
        },
      });
    });


    // EDIT COMPANY START

    $(document).on("click", ".btn-edit", function() {
      console.log("edit btn clicked");
      $("#edit-company-modal").modal("show");
      let companyName = $(this).closest("tr").find(".company-name").text().trim();
      let companyCode = $(this).closest("tr").find(".company-code").text().trim();
      
      $("#edit-company-name").val(companyName);
      $("#edit-company-code").val(companyCode);
      $(".save-company").attr("data-id", $(this).attr("data-id"));
    });

    $(document).on("click", ".save-company", function() {
      let companyName = $("#edit-company-name").val().trim();
      let companyCode = $("#edit-company-code").val().trim();
      let email = $("#edit-company-email").val().trim();
      let phone = $("#edit-company-phone").val().trim();
      let registrationNumber = $("#edit-registration-number").val().trim();
      let companyTypeLid = $("#edit-company-type").val();
      let companyId = $(this).attr("data-id");

      $.ajax({
        method: "POST",
        url: "/admin/company/update",
        headers: {
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          companyData: {
            companyLid: companyId,
            companyName: companyName,
            companyCode: companyCode,
            email: email,
            phone: phone,
            registrationNumber: registrationNumber,
            companyTypeLid: companyTypeLid
          }
        }),
        success: function(response) {
          $("#edit-company-modal").modal("hide");
          if (response.status === 200) {
            createAlert({
              title: 'Success',
              msg: response.data.message,
              type: "positive",
            });

            let row = $('#table-content').find(`tr[data-id="${companyId}"]`);
            row.find('.company-name').text(companyName);
            row.find('.company-code').text(companyCode);
          } else {
            createAlert({
              title: 'Error',
              msg: response.data.message,
              type: "negative",
            });
          }
        },
        error: function(error) {
          createAlert({
            title: 'Error',
            msg: 'Something went wrong!',
            type: "negative",
          });
        },
      });
    });
  });
  // EDIT COMPANY END


  // DELETE COMPANY START

  $(document).on('click', '.btn-delete', function() {
    let companyId = $(this).attr("data-id");
    let thisBtn = $(this);
    const isConfirmed = confirm('Are you sure you want to remove this company?');

    if (!isConfirmed) {
      return false;
    }

    $.ajax({
      method: "POST",
      url: "/admin/company/delete",
      headers: {
        'Content-Type': 'application/json'
      },
      data: JSON.stringify({
        companyLid: companyId
      }),
      success: function(response) {
        if (response.status === 200) {
          createAlert({
            title: 'Success',
            msg: 'Company deleted successfully!',
            type: "positive",
          });

          thisBtn.closest("tr").remove();
          $('.bs-tooltip-top').remove();
        } else {
          createAlert({
            title: 'ERROR',
            msg: response.data.message,
            type: "negative",
          });
        }
      },
      error: function(error) {
        createAlert({
          title: 'ERROR',
          msg: 'Something went wrong!',
          type: "negative",
        });
      },
    });
  })
</script>
<!--END CUSTOM JS SCRIPT -->

<%- include ('../partials/footer-end') %>

</html> 