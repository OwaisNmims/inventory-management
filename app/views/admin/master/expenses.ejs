<%- include ('../partials/head') %>

  <!--  BEGIN NAVBAR  -->
  <%- include ('../partials/header') %>
    <!--  END NAVBAR  -->

    <!--  BEGIN MAIN CONTAINER  -->
    <div class="main-container" id="container">

      <div class="overlay"></div>
      <div class="search-overlay"></div>

      <!--  BEGIN SIDEBAR  -->
      <%- include ('../partials/sidebar') %>
        <!--  END SIDEBAR  -->

        <!--  BEGIN CONTENT AREA  -->
        <div id="content" class="main-content">
          <div class="layout-px-spacing">

            <div class="middle-content container-xxl p-0">

              <!--  BEGIN BREADCRUMBS  -->
              <div class="secondary-nav">
                <div class="breadcrumbs-container" data-page-heading="Analytics">
                  <header class="header navbar navbar-expand-sm">
                    <a href="javascript:void(0);" class="btn-toggle sidebarCollapse" data-placement="bottom">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-menu">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                      </svg>
                    </a>
                    <div class="d-flex breadcrumb-content">
                      <div class="page-header">

                        <div class="page-title">
                        </div>

                        <nav class="breadcrumb-style-one" aria-label="breadcrumb">
                          <ol class="breadcrumb">
                            <li class="breadcrumb-item active"><a href="./masters">Master</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Expenses</li>
                          </ol>
                        </nav>

                      </div>
                    </div>

                  </header>
                </div>
              </div>
              <!--  END BREADCRUMBS  -->

              <div class="main-content">

                <div class="table-template">
                  <div class="table-header">
                    <div class="table-title">
                      <h3>Expenses</h3>
                    </div>
                    <div class="table-actions">
                      <button style="background: none; border: none;" data-bs-toggle="modal"
                        data-bs-target="#add-expense-modal"><i class="fa-regular fa-square-plus"></i> </button>
                    </div>
                  </div>

                  <div class="table-content">
                    <div class="table-filter-container"></div>
                    <div class="table-content">

                      <div class="table-responsive">
                        <table class="table table-bordered" id="table-content">
                          <thead>
                            <tr>
                              <th scope="col">Sr No.</th>
                              <th scope="col">Expense </th>
                              <th class="text-center" scope="col"> Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% expenseList.forEach((expense, idx)=> { %>
                              <tr>
                                <td><%- ++idx %></td>
                                <td class="expense-name"><%- expense.name %></td>
                                <td>
                                  <i data-id="<%- expense.id %>" class="fa-regular fa-pen-to-square cursor-pointer btn-edit"></i>
                                  <i data-id="<%- expense.id %>" class="fa-regular fa-trash-can text-danger btn-delete cursor-pointer"></i>
                                </td>
                              </tr>
                              <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
        <!--  END CONTENT AREA  -->

    </div>
    <!-- END MAIN CONTAINER -->

    <!--ADD Modal -->
    <div class="modal fade" id="add-expense-modal" tabindex="-1" role="dialog" aria-labelledby="add-expense-modal"
      aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content modal-inputform">
          <div class="modal-header  modal-inputform-header">
            <h5 class="modal-title text-dark" id="">ADD EXPENSE TYPE</h5>
            <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close"><i
                class="fas fa-times"></i></button>

          </div>
          <div class="modal-body">
            <div class="row info-container">
              <div class="col-md-3 select-fields">

                <div class="mb-3">
                  <label class="form-label" for="add-expense-input">Add Expenses</label>
                  <input type="text" class="form-control" id="add-expense-input"
                    placeholder="Type here..." />
                </div>

                <div class="mb-3 d-grid gap-2">
                  <button class="btn text-light add-expense btn-info">ADD</button>
                </div>

              </div>
              <div class="col-md-9 selected-fields">
                <div class="table-responsive">
                  <table class="table table-bordered" id="add-more-expense-table">
                    <thead>
                      <th>Sr No.</th>
                      <th>Expense</th>
                      <th>Action</th>
                    </thead>
                    <tbody>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn create-expense btn-primary">CREATE</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="edit-expense-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
      aria-labelledby="edit-country-modal" aria-hidden="true">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content modal-inputform">
          <div class="modal-header modal-inputform-header">
            <h5 class="modal-title text-dark" id="">EDIT EXPENSE</h5>
            <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="select-fields">
              <div class="mb-3">
                <label class="form-label" for="edit-expense-input">Name</label>
                <input type="text" class="form-control" id="edit-expense-input" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="save-edited-data" class="btn btn-primary">
              SAVE
            </button>
          </div>
        </div>
      </div>
    </div>

    <%- include ('../partials/footer') %>

      <!-- CUSTOM JS SCRIPT -->
      <script>
        $(document).ready(function () {

          // GLOBAL VARIABLES
          let expenseLid;
          let newExpenses = [];

          //APPEND EXPENSE IN TABLE
          $('#add-expense-modal .add-expense').on('click', function () {
            const expenseName = $('#add-expense-input').val();

            if (!isAlphabetWords(expenseName)) {
              createAlert({
                title: 'Incorrect input!',
                msg: 'Only alphabets and spaces are allowed.',
                type: 'negative',
              });

              return false;
            }

            // Check for duplicate before pushing
            const isDuplicate = newExpenses.some(expense => (
              expense.expenseName === expenseName
            ));

            if (isDuplicate) {
              createAlert({
                title: "Duplicate Data!",
                msg: "Duplicate entries detected.",
                type: "negative",
              });
              return false;
            }

            newExpenses.push({ expenseName });

            const newTr = $('<tr>');
            let rowCount = $('#add-more-expense-table tbody tr').length + 1;

            newTr.data('data-name', expenseName);

            newTr.append($('<td>').text(rowCount));
            newTr.append($('<td>').text(expenseName));
            newTr.append($('<td>').html(`<i class="fa-regular fa-trash-can delete-row-btn cursor-pointer"></i>`));

            $('#add-more-expense-table tbody').append(newTr);
          })

          //DELETE EXPENSE TR ROW
          $(document).on('click', '.delete-row-btn', function () {
            const tr = $(this).closest('tr');
            const expenseName = tr.data('data-name');

            // Remove row data from the array
            newExpenses.splice(newExpenses.findIndex(expense => (
              expense.expenseName === expenseName
            )), 1);

            tr.remove();
            updateSerialNumbers('#add-more-expense-table tbody tr');
          });


          //INSERT EXPENSES
          $('#add-expense-modal .create-expense').on('click', function () {
            console.log('new expenses>>>> ', newExpenses)

            if (newExpenses.length <= 0) {
              createAlert({
                title: 'Empty Expense List!',
                msg: 'Cannot create empty expense.',
                type: 'negative',
              });
              return;
            }

            $.ajax({
              method: 'POST',
              url: '/admin/expenses/add',
              data: {
                expenseList: newExpenses
              },
              success: function (response) {
                if (response.data.status == 'success') {
                  alert(response.data.message);
                  location.reload(true);
                } else {
                  createAlert({
                    title: 'ERROR',
                    msg: response.data.message,
                    type: 'negative',
                  });
                }
              },
              error: function (error) {
                createAlert({
                  title: 'ERROR',
                  msg: 'Something went wrong!',
                  type: 'negative',
                });
              },
            });
          })


          // EDIT EXPENSE 
          $(document).on('click', '.btn-edit', function () {
            expenseLid = $(this).attr('data-id');
            const thisTr = this.closest('tr');
            const expenseName = $(thisTr).find('.expense-name').text();

            $('#edit-expense-input').val(expenseName);
            $('#edit-expense-modal').modal('show');
          })

          // Save Edited Expense
          $(document).on('click', '#save-edited-data', function () {
            let expenseName = $('#edit-expense-input').val();

            $.ajax({
              method: 'POST',
              url: '/admin/expenses/update',
              data: {
                expenseData: { expenseName, expenseLid }
              },
              success: function (response) {
                if (response.status == 'success') {
                  alert(response.message);
                  location.reload(true);
                } else {
                  createAlert({
                    title: 'ERROR',
                    msg: response.message,
                    type: 'negative',
                  });
                }
              },
              error: function (error) {
                createAlert({
                  title: 'ERROR',
                  msg: 'Something went wrong.',
                  type: 'negative',
                });
              },
            });
          })

          // DELETE EXPENSE
          $(document).on('click', '.btn-delete', function () {
            expenseLid = $(this).attr('data-id');

            const isConfirmed = confirm('Are you sure you want to remove the expense?');

            if (!isConfirmed) {
              return false;
            }

            $.ajax({
              method: 'POST',
              url: '/admin/expenses/delete',
              data: {
                expenseData: { expenseLid }
              },
              success: function (response) {
                if (response.status == 'success') {
                  alert(response.message);
                  location.reload(true);
                } else {
                  createAlert({
                    title: 'ERROR',
                    msg: response.message,
                    type: 'negative',
                  });
                }
              },
              error: function (error) {
                createAlert({
                  title: 'ERROR',
                  msg: 'Something went worng!',
                  type: 'negative',
                });
              },
            });
          });

        })
      </script>
      <!--END CUSTOM JS SCRIPT -->

      <%- include ('../partials/footer-end') %>