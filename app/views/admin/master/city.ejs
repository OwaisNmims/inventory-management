<!DOCTYPE html>
<html lang="en">
<%- include ('../partials/head') %>

  <!--  BEGIN NAVBAR  -->
  <%- include ('../partials/header') %>
    <!--  END NAVBAR  -->

    <!--  BEGIN MAIN CONTAINER  -->
    <div class="main-container" id="container">
      <div class="overlay"></div>
      <div class="search-overlay"></div>

      <!--  BEGIN SIDEBAR  -->
      <%- include ('../partials/sidebar') %>
        <!--  END SIDEBAR  -->

        <!--  BEGIN CONTENT AREA  -->
        <div id="content" class="main-content">
          <div class="layout-px-spacing">
            <div class="middle-content container-xxl p-0">
              <!--  BEGIN BREADCRUMBS  -->
              <div class="secondary-nav">
                <div class="breadcrumbs-container" data-page-heading="Analytics">
                  <header class="header navbar navbar-expand-sm">
                    <a href="javascript:void(0);" class="btn-toggle sidebarCollapse" data-placement="bottom">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-menu">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                      </svg>
                    </a>
                    <div class="d-flex breadcrumb-content">
                      <div class="page-header">
                        <div class="page-title"></div>

                        <nav class="breadcrumb-style-one" aria-label="breadcrumb">
                          <ol class="breadcrumb">
                            <li class="breadcrumb-item active">
                              <a href="./masters">Master</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                              City
                            </li>
                          </ol>
                        </nav>
                      </div>
                    </div>
                  </header>
                </div>
              </div>
              <!--  END BREADCRUMBS  -->

              <div class="main-content">
                <div class="table-template">
                  <div class="table-header">
                    <div class="table-title">
                      <h3>City</h3>
                    </div>
                    <div class="table-actions">
                      <button style="background: none; border: none" data-bs-toggle="modal"
                        data-bs-target="#add-city-modal">
                        <i class="fa-regular fa-square-plus"></i>
                      </button>
                    </div>
                  </div>

                  <div class="table-content">
                    <div class="table-filter-container"></div>
                    <div class="table-content">
                      <div class="table-responsive">
                        <table class="table table-bordered" id="table-content">
                          <thead>
                            <tr>
                              <th scope="col">Sr No.</th>
                              <th scope="col">Country</th>
                              <th scope="col">State</th>
                              <th scope="col">City</th>
                              <th scope="col">Postal Code</th>
                              <th class="text-center" scope="col">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% cities.forEach((city, idx)=> { %>
                              <tr>
                                <td><%- ++idx %></td>
                                <td><%- city.country_name %></td>
                                <td><%- city.state_name %></td>
                                <td class="city-name"><%- city.name %></td>
                                <td class="postal-code"><%- city.postal_code %></td>
                                <td>
                                  <div class="action-btns">
                                    <a href="javascript:void(0);" class="action-btn btn-edit bs-tooltip me-2"
                                      data-toggle="tooltip" data-placement="top" title="Edit"
                                      data-city-id="<%-city.id%>">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-edit-2">
                                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                      </svg>
                                    </a>
                                    <a href="javascript:void(0);" class="action-btn btn-delete bs-tooltip"
                                      data-toggle="tooltip" data-placement="top" title="Delete"
                                      data-city-id="<%-city.id%>">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-trash-2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path
                                          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                        </path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                      </svg>
                                    </a>
                                  </div>
                                </td>
                              </tr>
                              <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!--  END CONTENT AREA  -->
    </div>
    <!-- END MAIN CONTAINER -->

    <!--ADD Modal -->
    <div class="modal fade" id="add-city-modal" tabindex="-1" role="dialog" aria-labelledby="add-city-modal"
      aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content modal-inputform">
          <div class="modal-header modal-inputform-header">
            <h5 class="modal-title text-dark" id="">ADD CITY</h5>
            <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="row info-container">
              <div class="col-md-3 select-fields">
                <div class="input-group mb-3 d-flex flex-column">
                  <label class="form-label">Country</label>
                  <select id="select-country" autocomplete="off" style="line-height: 30px">
                    <option value="" disabled selected>
                      Select a Country...
                    </option>
                    <% countries.forEach((country, idx)=> { %>
                      <option value="<%- country.id %>" data-country-name="<%- country.name %>">
                        <%- country.name %>
                      </option>
                      <% }) %>
                  </select>
                </div>

                <div class="input-group mb-3 d-flex flex-column">
                  <label class="form-label">State</label>
                  <select id="select-state" autocomplete="off" style="line-height: 30px">
                    <option value="" disabled selected>Select a State...</option>
                  </select>
                </div>

                <div class="input-group mb-3 d-flex flex-column">
                  <label class="form-label">City</label>
                  <input type="text" id="city" name="city" placeholder="Type city name" />
                </div>

                <div class="input-group mb-3 d-flex flex-column">
                  <label class="form-label">Postal Code</label>
                  <input type="text" name="postal-code" id="postal-code" class="form-control w-100" />
                </div>
                <!-- 
                            <div class="input-group mb-3 d-flex flex-column">
                                <label class="form-label">Short Name</label>
                                <input type="text" name="city" id="city-abbr" class="form-control w-100">
                            </div> -->

                <div class="mb-3 d-grid gap-2">
                  <button class="btn text-light add-city btn-info">ADD</button>
                </div>
              </div>
              <div class="col-md-9 selected-fields">
                <div class="table-responsive">
                  <table class="table table-bordered" id="add-more-city-table">
                    <thead>
                      <th>Sr No.</th>
                      <th>Country</th>
                      <th>State</th>
                      <th>City</th>
                      <th>Postal Code</th>
                      <!-- <th>Short Name</th> -->
                      <th>Action</th>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn create-city btn-primary">
              CREATE
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit City Modal -->
    <div class="modal fade" id="edit-city-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
      aria-labelledby="edit-country-modal" aria-hidden="true">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content modal-inputform">
          <div class="modal-header modal-inputform-header">
            <h5 class="modal-title text-dark" id="">EDIT CITY</h5>
            <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="select-fields">
              <div class="mb-3">
                <label class="form-label" for="edit-city-input">City Name</label>
                <input type="text" class="form-control" id="edit-city-input" />
              </div>
              <div class="mb-3">
                <label class="form-label" for="edit-postal-code">Postal Code</label>
                <input type="text" class="form-control" id="edit-postal-code" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="save-edited-data" class="btn btn-primary">
              SAVE
            </button>
          </div>
        </div>
      </div>
    </div>


    <%- include ('../partials/footer') %>
      <!-- CUSTOM JS SCRIPT -->
      <script>

        $(document).ready(function () {

          // GLOBAL VARIABLES
          let cityLid;
          let newCities = [];

          // INIT Select2
          $('#select-country').select2({
            dropdownParent: $('#add-city-modal')
          });

          $('#select-state').select2({
            dropdownParent: $('#add-city-modal')
          });

          //INSERT CITY
          $('#add-city-modal .add-city').on('click', function () {
            const countryLid = $('#select-country').val();
            const countryName = $('#select-country option:selected').attr('data-country-name');
            const stateLid = $('#select-state').val();
            const stateName = $('#select-state option:selected').attr('data-name');
            const city = $('#city').val();
            const postalCode = $('#postal-code').val();

            if (!isNumber(countryLid) || !isNumber(stateLid) || !isAlphabetWords(city) || !isAlphaNumeric(postalCode)) {
              createAlert({
                title: "Incorrect input!",
                msg: "Incorrect input, please check and try again.",
                type: "negative",
              });

              return false;
            }

            // Check for duplicate before pushing
            const isDuplicate = newCities.some(rowData => (
              rowData.countryLid === countryLid &&
              rowData.stateLid === stateLid &&
              rowData.postalCode === postalCode
            ));

            if (isDuplicate) {
              createAlert({
                title: "Duplicate Data!",
                msg: "Duplicate entries detected.",
                type: "negative",
              });
              return false;
            }

            newCities.push({ countryLid, stateLid, city, postalCode });

            const newTr = $('<tr>');
            let rowCount = $('#add-more-city-table tbody tr').length + 1;

            newTr.data('country-lid', countryLid);
            newTr.data('state-lid', stateLid);
            newTr.data('city', city);
            newTr.data('postal-code', postalCode);

            newTr.append($('<td>').text(rowCount));
            newTr.append($('<td>').text(countryName));
            newTr.append($('<td>').text(stateName));
            newTr.append($('<td>').text(city));
            newTr.append($('<td>').text(postalCode));
            newTr.append($('<td>').html(`<i class="fa-regular fa-trash-can delete-row-btn cursor-pointer"></i>`));

            $('#add-more-city-table tbody').append(newTr);
          })

          // Delete row button click handler
          $(document).on('click', '.delete-row-btn', function () {
            const tr = $(this).closest('tr');
            const countryLid = tr.data('country-lid');
            const stateLid = tr.data('state-lid');
            const city = tr.data('city');
            const postalCode = tr.data('postal-code');

            // Remove row data from the array
            newCities.splice(newCities.findIndex(city => (
              city.countryLid === countryLid &&
              city.stateLid === stateLid &&
              city.city === city &&
              city.postalCode === postalCode
            )), 1);

            tr.remove();
            updateSerialNumbers('#add-more-city-table tbody tr');
          });

          $('#add-city-modal .create-city').on('click', function () {
            console.log('new cities>>>> ', newCities)
            if (newCities.length <= 0) {
              createAlert({
                title: "Empty City List!",
                msg: "Cannot create empty city.",
                type: "negative",
              });
              return;
            }

            $.ajax({
              method: "POST",
              url: "/admin/city/add",
              data: {
                cityList: newCities
              },
              success: function (response) {
                if (response.data.status == 'success') {
                  alert(response.data.message);
                  location.reload(true);
                } else {
                  createAlert({
                    title: "ERROR",
                    msg: response.data.message,
                    type: "negative",
                  });
                  $("#edit-city-modal").modal("hide");
                }
                $("#edit-city-modal").modal("hide");
              },
              error: function (error) {
                createAlert({
                  title: "ERROR",
                  msg: response.data.message,
                  type: "negative",
                });
                $("#edit-city-modal").modal("hide");
              },
            });
          })

          // EDIT CITY 
          $(document).on('click', '.btn-edit', function () {
            cityLid = $(this).attr('data-city-id');
            const thisTr = this.closest('tr');
            const cityName = $(thisTr).find('.city-name').text();
            const postalCode = $(thisTr).find('.postal-code').text();
            $('#edit-city-input').val(cityName);
            $('#edit-postal-code').val(postalCode);
            $('#edit-city-modal').modal('show');
          })

          // Save Edited City
          $(document).on('click', '#save-edited-data', function () {
            let cityName = $('#edit-city-input').val();
            let postalCode = $('#edit-postal-code').val();

            $.ajax({
              method: "POST",
              url: "/admin/city/update",
              data: {
                cityData: { cityLid, cityName, postalCode }
              },
              success: function (response) {
                if (response.data.status == 'success') {
                  alert("Updated Successfully!");
                  location.reload(true);
                } else {
                  createAlert({
                    title: "ERROR",
                    msg: response.data.message,
                    type: "negative",
                  });
                  $("#edit-city-modal").modal("hide");
                }
                $("#edit-city-modal").modal("hide");
              },
              error: function (error) {
                createAlert({
                  title: "ERROR",
                  msg: "not done",
                  type: "negative",
                });
                $("#edit-city-modal").modal("hide");
              },
            });

            $('#edit-city-modal').modal('hide');
          })

          // DELETE CITY
          $(document).on('click', '.btn-delete', function () {
            cityLid = $(this).attr('data-city-id');

            const isConfirmed = confirm('Are you sure you want to remove the city?');

            if (!isConfirmed) {
              return false;
            }

            $.ajax({
              method: "POST",
              url: "/admin/city/delete",
              data: {
                cityData: { cityLid }
              },
              success: function (response) {
                if (response.message == 'Success') {
                  alert("SUCCESS - Successfully Deleted!");
                  location.reload(true);
                } else {
                  createAlert({
                    title: "ERROR",
                    msg: response.message,
                    type: "negative",
                  });
                }
              },
              error: function (error) {
                createAlert({
                  title: "ERROR",
                  msg: 'Something went wrong!',
                  type: "negative",
                });
              },
            });
          });


          //FETCH AND UPDATE STATES
          $("#select-country").on("change", function () {
            const countryLid = $(this).val();

            $.ajax({
              method: "GET",
              url: `/admin/state/find-by-country?countryLid=${countryLid}`,
              success: function (response) {
                if (response.message == "success") {
                  const selectOptions = {
                    selector: "#select-state",
                    textAttr: "name",
                    valueAttr: "id",
                    data: response.states,
                  };

                  createSelectOptions(selectOptions);

                  $("#select-state").select2("destroy");

                  $("#select-state").select2({
                    dropdownParent: $("#add-city-modal"),
                  });
                } else {
                  createAlert({
                    title: "ERROR",
                    msg: response.message,
                    type: "negative",
                  });
                }
              },
              error: function (error) {
                createAlert({
                  title: "ERROR",
                  msg: response.message,
                  type: "negative",
                });
              }
            })
          })
        })

      </script>
      <!--END CUSTOM JS SCRIPT -->
      <%- include ('../partials/footer-end') %>

</html>