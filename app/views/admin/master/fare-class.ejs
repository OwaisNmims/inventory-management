<%- include ('../partials/head') %>

<!--  BEGIN NAVBAR  -->
<%- include ('../partials/header') %>
<!--  END NAVBAR  -->

<!--  BEGIN MAIN CONTAINER  -->
<div class="main-container" id="container">

  <div class="overlay"></div>
  <div class="search-overlay"></div>

  <!--  BEGIN SIDEBAR  -->
  <%- include ('../partials/sidebar') %>
  <!--  END SIDEBAR  -->

  <!--  BEGIN CONTENT AREA  -->
  <div id="content" class="main-content">
    <div class="layout-px-spacing">

      <div class="middle-content container-xxl p-0">

        <!--  BEGIN BREADCRUMBS  -->
        <div class="secondary-nav">
          <div class="breadcrumbs-container" data-page-heading="Analytics">
            <header class="header navbar navbar-expand-sm">
              <a href="javascript:void(0);" class="btn-toggle sidebarCollapse" data-placement="bottom">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
              </a>
              <div class="d-flex breadcrumb-content">
                <div class="page-header">

                  <div class="page-title">
                  </div>

                  <nav class="breadcrumb-style-one" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li class="breadcrumb-item active"><a href="./masters">Master</a></li>
                      <li class="breadcrumb-item active" aria-current="page">Fare Class</li>
                    </ol>
                  </nav>

                </div>
              </div>

            </header>
          </div>
        </div>
        <!--  END BREADCRUMBS  -->

        <div class="main-content">

          <div class="table-template">
            <div class="table-header">
              <div class="table-title">
                <h3>Fare Class</h3>
              </div>
              <div class="table-actions">
                <button style="background: none; border: none;" data-bs-toggle="modal" data-bs-target="#add-fare-class-modal"><i class="fa-regular fa-square-plus"></i> </button>
              </div>
            </div>

            <div class="table-content">
              <div class="table-filter-container"></div>
              <div class="table-content">

                <div class="table-responsive">
                  <table class="table table-bordered" id="table-content">
                    <thead>
                      <tr>
                        <th scope="col">Sr No.</th>
                        <th scope="col">Mode of Transport</th>
                        <th scope="col">Fare Class</th>
                        <th class="text-center" scope="col"> Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% fareClasses.forEach((classs, idx)=>{%>
                        <tr>
                          <td><%- ++idx %></td>
                          <td class="mode-name"><%-classs.mode_of_transport %></td>
                          <td class="fare-class-name"><%-classs.name %></td>
                          <td class="text-center">
                            <div class="action-btns">
                              <a href="javascript:void(0);" class="action-btn btn-edit bs-tooltip me-2"
                                data-toggle="tooltip" data-placement="top" title="Edit"
                                data-fare-class-id="<%-classs.id%>">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round" class="feather feather-edit-2">
                                  <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z">
                                  </path>
                                </svg>
                              </a>
                              <a href="javascript:void(0);" class="action-btn btn-delete bs-tooltip"
                                data-toggle="tooltip" data-placement="top" title="Delete"
                                data-fare-class-id="<%-classs.id%>">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                  stroke-linejoin="round" class="feather feather-trash-2">
                                  <polyline points="3 6 5 6 21 6"></polyline>
                                  <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                  </path>
                                  <line x1="10" y1="11" x2="10" y2="17"></line>
                                  <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                              </a>
                            </div>
                          </td>
                        </tr>
                      <%})%>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
  <!--  END CONTENT AREA  -->

</div>
<!-- END MAIN CONTAINER -->

<!--ADD Modal -->
<div class="modal fade" id="add-fare-class-modal" tabindex="-1" role="dialog" aria-labelledby="add-fare-class-modal"
aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content modal-inputform">
            <div class="modal-header  modal-inputform-header">
                <h5 class="modal-title text-dark" id="">ADD CARRIER</h5>
                <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close"><i
                        class="fas fa-times"></i></button>

            </div>
            <div class="modal-body">
                <div class="row info-container">
                    <div class="col-md-3 select-fields">
                       
                        <div class="input-group mb-3 d-flex flex-column">
                            <label class="form-label">Mode of Transport</label>
                            <select id="select-mode" autocomplete="off" style="line-height: 30px;">
                                <option value="" selected disabled>Select a Mode of Transport...</option>
                                <% modes.forEach((mode, idx)=> { %>
                                   <option value="<%- mode.id %>" data-mode-name="<%- mode.name %>"><%- mode.name %>
                                   </option>
                                   <% }) %>
                            </select>
                       </div>       

                        <div class="input-group mb-3 d-flex flex-column">
                           <label class="form-label">Fare Class</label>
                           <input type="text" name="fare-class-name" id="fare-class-name">
                       </div>       

                        <div class="mb-3 d-grid gap-2">
                            <button class="btn text-light add-fare-class btn-info">ADD</button>
                        </div>
                        
                    </div>
                    <div class="col-md-9 selected-fields"> 
                        <div class="table-responsive">
                            <table class="table table-bordered" id="add-more-fare-class-table">
                                <thead>
                                    <th>Sr No.</th>
                                    <th>Mode of Transport</th>
                                    <th>Fare Class</th>
                                    <th>Action</th>
                                </thead>
                                <tbody>
                                   
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn create-fare-class btn-primary">CREATE</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Mode Modal -->
<div class="modal fade" id="edit-fare-class-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
aria-labelledby="edit-dare-class-modal" aria-hidden="true">
<div class="modal-dialog modal-sm" role="document">
<div class="modal-content modal-inputform">
    <div class="modal-header modal-inputform-header">
    <h5 class="modal-title text-dark" id="">EDIT FARE CLASS</h5>
    <button type="button" class="btn fs-4 text-dark" data-bs-dismiss="modal" aria-label="Close">
        <i class="fas fa-times"></i>
    </button>
    </div>
    <div class="modal-body">
    <div class="select-fields">
        <div class="mb-3">
        <label class="form-label" for="edit-fare-class-input">Fare Class Name</label>
        <input type="text" class="form-control" id="edit-fare-class-input" />
        </div>
        
    </div>
    </div>
    <div class="modal-footer">
    <button type="button" id="save-edited-data" class="btn btn-primary">SAVE</button>
    </div>
</div>
</div>
</div>
<%- include ('../partials/footer') %>


<!-- CUSTOM JS SCRIPT -->
<script>
  $(document).ready(function() {

    // GLOBAL VARIABLES
    let fareClassLid;
    let newfareClasses = [];

      // INIT Select2
    $('#select-mode').select2({
        dropdownParent: $('#add-fare-class-modal')
    });

    //Insert CARRIER
    $('#add-fare-class-modal .add-fare-class').on('click', function () {
                
      const fareClassName = $('#fare-class-name').val().trim().toUpperCase();
      const transportModeLid = $('#select-mode').val();
      const transportMode = $('#select-mode option:selected').attr('data-mode-name');

      if (!isAlphaNumeric(fareClassName)) {
      createAlert({
          title: "Incorrect input!",
          msg: "Incorrect input, please check and try again.",
          type: "negative",
      });

      return false;
      }

      // Check for duplicate before pushing
      const isDuplicate = newfareClasses.some(rowData => (
          rowData.fareClassName === fareClassName &&
          rowData.transportModeLid === transportModeLid
      ));

      if (isDuplicate) {
      createAlert({
          title: "Duplicate Data!",
          msg: "Duplicate entries detected.",
          type: "negative",
      });
      return false;
      }

      newfareClasses.push({fareClassName, transportModeLid});

      const newTr = $('<tr>');
      let rowCount = $('#add-more-fare-class-table tbody tr').length + 1;

      
      newTr.data('transport-mode-lid', transportModeLid);
      newTr.data('fare-class-name', fareClassName);

      newTr.append($('<td>').text(rowCount));
      newTr.append($('<td>').text(transportMode));
      newTr.append($('<td>').text(fareClassName));
      newTr.append($('<td>').html(`<i class="fa-regular fa-trash-can delete-row-btn cursor-pointer"></i>`));

      $('#add-more-fare-class-table tbody').append(newTr);
  })

    // Delete row button click handler
    $(document).on('click', '.delete-row-btn', function () {
        const tr = $(this).closest('tr');
        const fareClassName = tr.data('fare-class-name');
        const transportModeLid = tr.data('transport-mode-lid');

        // Remove row data from the array
        newfareClasses.splice(newfareClasses.findIndex(classs => (
            classs.fareClassName === fareClassName &&
            classs.transportModeLid === transportModeLid
        )), 1);

        tr.remove();
        updateSerialNumbers('#add-more-fare-class-table tbody tr');
    });

    //INSERT API CALL
    $(document).on('click', '.create-fare-class', function(){
        console.log('FINAL ARRAY', newfareClasses)    
        $.ajax({
            method: "POST",
            url: "/admin/fare-class/add",
            data: {
                fareClassData: newfareClasses
            },
            success: function (response) {
            
            if (response.status == 200) {
                alert(`${response.data.message}`);
                location.reload(true);
            } else {
                createAlert({
                title: "ERROR",
                msg: response.data.message,
                type: "negative",
                });
                $("#add-carrier-modal").modal("hide");
            }
            $("#add-carrier-modal").modal("hide");
            },
            error: function (error) {
            
            createAlert({
                title: "ERROR",
                msg: "not done",
                type: "negative",
            });

            $("#add-carrier-modal").modal("hide");
            },
        });

        $('#add-carrier-modal').modal('hide');
    })

    // EDIT FARE-CLASS 
    $(document).on('click', '.btn-edit', function () {
      fareClassLid = $(this).attr('data-fare-class-id');
      const thisTr = this.closest('tr');
      const modeName = $(thisTr).find('.fare-class-name').text();

      $('#edit-fare-class-input').val(modeName);
      $('#edit-fare-class-modal').modal('show');
    })

    // Save Edited CARRIER
    $(document).on('click', '#save-edited-data', function () {
      let newFareClassName = $('#edit-fare-class-input').val().trim().toUpperCase();

      $.ajax({
          method: "POST",
          url: "/admin/fare-class/update",
          data: {
              fareClassData: { fareClassLid, newFareClassName }
          },
          success: function (response) {
          if (response.status == 200) {
              alert(`${response.data.message}`);
              location.reload(true);
          } else {
              createAlert({
              title: "ERROR",
              msg: response.data.message,
              type: "negative",
              });
              $("#edit-carrier-modal").modal("hide");
          }
          $("#edit-carrier-modal").modal("hide");
          },
          error: function (error) {
          createAlert({
              title: "ERROR",
              msg: "not done",
              type: "negative",
          });
          $("#edit-carrier-modal").modal("hide");
          },
      });

      $('#edit-carrier-modal').modal('hide');
    })

    // DELETE CARRIER
    $(document).on('click', '.btn-delete', function () {
        fareClassLid = $(this).attr('data-fare-class-id');
        const isConfirmed = confirm('Are you sure you want to remove the Fare class?');

        if (!isConfirmed) {
            return false;
        }

        $.ajax({
            method: "POST",
            url: "/admin/fare-class/delete",
            data: {
                fareClassData: { fareClassLid }
            },
            success: function (response) {
            if (response.status == 200) {
                alert("SUCCESS - Successfully Deleted!");
                location.reload(true);
            } else {
                createAlert({
                title: "ERROR",
                msg: response.message,
                type: "negative",
                });
            }
            },
            error: function (error) {
            createAlert({
                title: "ERROR",
                msg: error.message,
                type: "negative",
            });
            },
        });
    })
  })
</script>
<!--END CUSTOM JS SCRIPT -->

<%- include ('../partials/footer-end') %>