<%- include ('../partials/head') %>

<!--  BEGIN NAVBAR  -->
<%- include ('../partials/header') %>
<!--  END NAVBAR  -->

<!--  BEGIN MAIN CONTAINER  -->
<div class="main-container" id="container">
  <div class="overlay"></div>
  <div class="search-overlay"></div>

  <!--  BEGIN SIDEBAR  -->
  <%- include ('../partials/sidebar') %>
  <!--  END SIDEBAR  -->

  <!--  BEGIN CONTENT AREA  -->
  <div id="content" class="main-content">
    <div class="layout-px-spacing">
      <div class="middle-content container-xxl p-0">
        <!--  BEGIN BREADCRUMBS  -->
        <div class="secondary-nav">
          <div class="breadcrumbs-container" data-page-heading="Analytics">
            <header class="header navbar navbar-expand-sm">
              <a
                href="javascript:void(0);"
                class="btn-toggle sidebarCollapse"
                data-placement="bottom"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="feather feather-menu"
                >
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
              </a>
              <div class="d-flex breadcrumb-content">
                <div class="page-header">
                  <div class="page-title"></div>

                  <nav class="breadcrumb-style-one" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li class="breadcrumb-item active">
                        <a href="./masters">Master</a>
                      </li>
                      <li class="breadcrumb-item active" aria-current="page">
                        Tax
                      </li>
                    </ol>
                  </nav>
                </div>
              </div>
            </header>
          </div>
        </div>
        <!--  END BREADCRUMBS  -->

        <div class="main-content">
          <div class="table-template">
            <div class="table-header">
              <div class="table-title">
                <h3>Tax</h3>
              </div>
              <div class="table-actions">
                <button
                  style="background: none; border: none"
                  data-bs-toggle="modal"
                  data-bs-target="#add-tax-modal"
                >
                  <i class="fa-regular fa-square-plus"></i>
                </button>
              </div>
            </div>

            <div class="table-content">
              <div class="table-filter-container"></div>
              <div class="table-content">
                <div class="table-responsive">
                  <table class="table table-bordered" id="table-content">
                    <thead>
                      <tr>
                        <th scope="col">Sr No.</th>
                        <th scope="col">Tax</th>
                        <th scope="col">Percentage</th>
                        <th class="text-center" scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% users.forEach((user, idx) => { %>
                      <tr>
                        <td><%- ++idx %></td>
                        <td class="tax-name"><%- tax.name %></td>
                        <td class="tax-percentage"><%- tax.percentage %></td>
                        <td class="text-center">
                          <div class="action-btns">
                            <a
                              href="javascript:void(0);"
                              class="action-btn btn-edit bs-tooltip me-2"
                              data-toggle="tooltip"
                              data-placement="top"
                              title="Edit"
                              data-tax-id="<%- tax.id %>"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                class="feather feather-edit-2"
                              >
                                <path
                                  d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                                ></path>
                              </svg>
                            </a>
                            <a
                              href="javascript:void(0);"
                              class="action-btn btn-delete bs-tooltip"
                              data-toggle="tooltip"
                              data-placement="top"
                              title="Delete"
                              data-tax-id="<%- tax.id %>"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                class="feather feather-trash-2"
                              >
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                                ></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                              </svg>
                            </a>
                          </div>
                        </td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--  END CONTENT AREA  -->
</div>
<!-- END MAIN CONTAINER -->

<!--ADD Modal -->
<div
  class="modal fade"
  id="add-tax-modal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="add-tax-modal"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content modal-inputform">
      <div class="modal-header modal-inputform-header">
        <h5 class="modal-title text-dark" id="">ADD TAX</h5>
        <button
          type="button"
          class="btn fs-4 text-dark"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="row info-container">
          <div class="col-md-3 select-fields">
            <div class="input-group mb-3 d-flex flex-column">
              <label class="form-label">Tax</label>
              <input
                type="text"
                id="tax"
                name="tax"
                placeholder="Type tax name"
              />
            </div>
            <div class="input-group mb-3 d-flex flex-column">
              <label class="form-label">Percentage</label>
              <input
                type="number"
                id="percentage"
                name="percentage"
                placeholder="Type tax Percentage"
                min="1"
                max="100"
                onkeyup="if(parseInt(this.value)>100){ this.value =100; return false; }"
              />
            </div>

            <div class="mb-3 d-grid gap-2">
              <button class="btn text-light add-tax btn-info">ADD</button>
            </div>
          </div>
          <div class="col-md-9 selected-fields">
            <div class="table-responsive">
              <table class="table table-bordered" id="add-more-tax-table">
                <thead>
                  <th>Sr No.</th>
                  <th>Tax</th>
                  <th>Percentage</th>
                  <th>Action</th>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn create-tax btn-primary">CREATE</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit tax Modal -->
<div
  class="modal fade"
  id="edit-tax-modal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  aria-labelledby="edit-tax-modal"
  aria-hidden="true"
>
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content modal-inputform">
      <div class="modal-header modal-inputform-header">
        <h5 class="modal-title text-dark" id="">EDIT TAX</h5>
        <button
          type="button"
          class="btn fs-4 text-dark"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="select-fields">
          <div class="mb-3">
            <label class="form-label" for="edit-tax-input">Tax</label>
            <input type="text" class="form-control" id="edit-tax-input" />
          </div>
          <div class="mb-3">
            <label class="form-label" for="edit-tax-percentage"
              >Percentage</label
            >
            <input type="text" class="form-control" id="edit-tax-percentage" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="save-edited-data" class="btn btn-primary">
          SAVE
        </button>
      </div>
    </div>
  </div>

  <%- include ('../partials/footer') %>

  <!-- CUSTOM JS SCRIPT -->
  <script>
    $(document).ready(function () {
      // GLOBAL VARIABLES
      let taxId;
      let newTax = [];

      // ADD tax
      $("#add-tax-modal .add-tax").on("click", function () {
        const percentage = Number($("#percentage").val());
        const tax = $("#tax").val().toUpperCase();

        console.log("percentage:::::>", percentage);

        if (!isAlphabetWords(tax)) {
          createAlert({
            title: "Incorrect input!",
            msg: "Incorrect input, please check and try again.",
            type: "negative",
          });

          return false;
        }

        function isNumberInRange(num) {
          // Check if it's a number and not NaN
          if (typeof num === "number" && !isNaN(num)) {
            // Check if it's within the range [0, 100]
            return num > 0 && num <= 100;
          }
          return false;
        }

        if (!isNumberInRange(percentage)) {
          createAlert({
            title: "Incorrect input!",
            msg: "Incorrect input, please check and try again.",
            type: "negative",
          });

          return false;
        }

        // Check for duplicate before pushing
        const isDuplicate = newTax.some((rowData) => rowData.tax === tax);

        if (isDuplicate) {
          createAlert({
            title: "Duplicate Data!",
            msg: "Duplicate entries detected.",
            type: "negative",
          });
          return false;
        }

        newTax.push({ tax, percentage });

        const newTr = $("<tr>");
        let rowCount = $("#add-more-tax-table tbody tr").length + 1;

        newTr.data("percentage", percentage);
        newTr.data("tax", tax);

        newTr.append($("<td>").text(rowCount));
        newTr.append($("<td>").text(tax));
        newTr.append($("<td>").text(percentage));
        newTr.append(
          $("<td>").html(
            `<i class="fa-regular fa-trash-can delete-row-btn cursor-pointer"></i>`
          )
        );

        $("#add-more-tax-table tbody").append(newTr);
      });

      // Delete row button click handler
      $(document).on("click", ".delete-row-btn", function () {
        const tr = $(this).closest("tr");
        const percentage = tr.data("percentage");
        const tax = tr.data("tax");

        // Remove row data from the array
        newTax.splice(
          newTax.findIndex(
            (tax) => tax.percentage === percentage && tax.tax === tax
          ),
          1
        );

        tr.remove();
        updateSerialNumbers("#add-more-tax-table tbody tr");
      });

      // CREATE tax
      $("#add-tax-modal .create-tax").on("click", function () {
        console.log("new tax create btn>>>> ", newTax);
        if (newTax.length <= 0) {
          createAlert({
            title: "Empty tax List!",
            msg: "Cannot create empty tax.",
            type: "negative",
          });
          return;
        }
        console.log("before ajax tax :::>>>", newTax);

        $.ajax({
          method: "POST",
          url: "/admin/tax/add",
          data: {
            input_json: JSON.stringify(newTax),
          },
          success: function (response) {
            // console.log("responce ::>>::>>",response);
            // console.log("responce msg::>>::>>",response);
            if (response.data.status == 200) {
              alert(response.data.message);
              location.reload(true);
            } else {
              createAlert({
                title: "ERROR",
                msg: response.data.message,
                type: "negative",
              });
            }
          },
          error: function (error) {
            createAlert({
              title: "ERROR",
              msg: response.data.message,
              type: "negative",
            });
          },
        });
      });
      // EDIT TAX
      $(document).on("click", ".btn-edit", function () {
        taxId = $(this).attr("data-tax-id");
        const thisTr = this.closest("tr");
        const taxName = $(thisTr).find(".tax-name").text();
        const taxPercentage = $(thisTr).find(".tax-percentage").text();
        $("#edit-tax-input").val(taxName);
        $("#edit-tax-percentage").val(taxPercentage);
        $("#edit-tax-modal").modal("show");
      });

      // Save Edited tax
      $(document).on("click", "#save-edited-data", function () {
        let taxName = $("#edit-tax-input").val().toUpperCase();
        let taxPercentage = $("#edit-tax-percentage").val();

        $.ajax({
          method: "POST",
          url: "/admin/tax/update",
          data: {
            taxData: { taxId, taxName, taxPercentage },
          },
          success: function (response) {
            console.log("response in edit tax", response);
            // console.log("response in update tax",response.message);
            if (response.data.status == "success") {
              alert(response.data.message);
              location.reload(true);
            } else {
              createAlert({
                title: "ERROR",
                msg: response.data.message,
                type: "negative",
              });
            }
          },
          error: function (error) {
            createAlert({
              title: "ERROR",
              msg: response.data.message,
              type: "negative",
            });
          },
        });
      });

      // DELETE TAX
      $(document).on("click", ".btn-delete", function () {
        taxId = $(this).attr("data-tax-id");

        const isConfirmed = confirm(
          "Are you sure you want to remove the city?"
        );

        if (!isConfirmed) {
          return false;
        }

        $.ajax({
          method: "POST",
          url: "/admin/tax/delete",
          data: {
            taxData: { taxId },
          },
          success: function (response) {
						console.log(response);
            if (response.status == true) {
              alert(response.message);
              location.reload(true);
            } else {
              createAlert({
                title: "ERROR",
                msg: response.message,
                type: "negative",
              });
            }
          },
          error: function (error) {
            createAlert({
              title: "ERROR",
              msg: response.message,
              type: "negative",
            });
          },
        });
      });
    });
  </script>
  <!--END CUSTOM JS SCRIPT -->

  <%- include ('../partials/footer-end') %>
</div>
